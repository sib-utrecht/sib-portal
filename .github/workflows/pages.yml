name: Deploy multi-branch to GitHub Pages

on:
  push:
    branches:
      - '**' # deploy every branch
  workflow_dispatch:

permissions:
  contents: write # needed to push to gh-pages

concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: true

env:
  # default, overridden per-branch in the "Compute basePath" step
  NEXT_PUBLIC_BASE_PATH: "/${{ github.event.repository.name }}"

jobs:
  build-and-deploy:
    name: Build and deploy (gh-pages)
    runs-on: ubuntu-latest
    # Do not run on gh-pages itself to avoid loops
    if: github.ref != 'refs/heads/gh-pages'
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Compute basePath and target subdir
        id: vars
        run: |
          REPO="${{ github.event.repository.name }}"
          BRANCH="${GITHUB_REF_NAME}"
          SLUG=$(echo "$BRANCH" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9._-]+/-/g' | sed -E 's/^-+|-+$//g')
          if [ "$BRANCH" = "main" ]; then
            BASE="/$REPO"
            SUBDIR="."
          else
            BASE="/$REPO/versions/$SLUG"
            SUBDIR="versions/$SLUG"
          fi
          echo "base_path=$BASE" >> $GITHUB_OUTPUT
          echo "subdir=$SUBDIR" >> $GITHUB_OUTPUT
          echo "Branch=$BRANCH slug=$SLUG base=$BASE subdir=$SUBDIR"

      # For GitHub Pages we export a static site to ./out
      - name: Build (Next.js static export)
        env:
          NEXT_PUBLIC_BASE_PATH: ${{ steps.vars.outputs.base_path }}
        run: |
          echo "Using basePath=${NEXT_PUBLIC_BASE_PATH}"
          pnpm build
          # Next 15+ export happens automatically when output:'export' is set

      - name: Checkout existing gh-pages into publish (if exists)
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: publish

      - name: Stage site into publish directory (preserve versions on main)
        run: |
          mkdir -p publish
          if [ "${{ steps.vars.outputs.subdir }}" = "." ]; then
            echo "Main branch: cleaning publish root except 'versions/'"
            find publish -mindepth 1 -maxdepth 1 ! -name versions -exec rm -rf {} +
            rsync -a ./out/ publish/
          else
            echo "Branch deploy: cleaning target subdir '${{ steps.vars.outputs.subdir }}'"
            rm -rf "publish/${{ steps.vars.outputs.subdir }}"
            mkdir -p "publish/${{ steps.vars.outputs.subdir }}"
            rsync -a ./out/ "publish/${{ steps.vars.outputs.subdir }}/"
          fi

      - name: Deploy to gh-pages (keeps other versions)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./publish
          keep_files: false
          user_name: github-actions[bot]
          user_email: 41898282+github-actions[bot]@users.noreply.github.com
