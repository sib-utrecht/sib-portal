(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[323],{7941:(e,t,n)=>{"use strict";n.d(t,{A:()=>C,O:()=>v});var o=n(6874),r=n(914),s=n(2405),l=n(3825),i=n(1103),a=n(233),u=n(1564);let c=(0,r.createContext)(void 0),g={UserPoolId:u.env.NEXT_PUBLIC_COGNITO_USER_POOL_ID||"",ClientId:u.env.NEXT_PUBLIC_COGNITO_CLIENT_ID||""},d=u.env.NEXT_PUBLIC_AWS_REGION||"eu-central-1",I=e=>new s.NE({...g,Storage:e}),m=()=>I(k()),h=new l.k({region:d}),f=e=>{try{return(JSON.parse(atob(e.split(".")[1]))["cognito:groups"]||[]).includes("admins")}catch(e){return console.error("Failed to decode JWT:",e),!1}},S="cognito_jwt_token",E="cognito_refresh_token",w="cognito_username",_="cognito_token_expiry",T="cognito_keep_logged_in",k=()=>"true"===localStorage.getItem(T)?localStorage:sessionStorage;function v(e){let{children:t}=e,[n,l]=(0,r.useState)(!1),[u,d]=(0,r.useState)(!0),[v,C]=(0,r.useState)(null),[A,P]=(0,r.useState)(null),[R,p]=(0,r.useState)(!1),[U,N]=(0,r.useState)(null),y=function(e,t,n){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"true"===localStorage.getItem(T);C(e),l(!0),p(f(e)),localStorage.setItem(T,o.toString());let r=o?localStorage:sessionStorage;r.setItem(S,e),t&&r.setItem(E,t),n&&r.setItem(w,n);try{let t=JSON.parse(atob(e.split(".")[1])),n=1e3*t.exp;r.setItem(_,n.toString())}catch(e){console.error("Failed to parse token expiry:",e)}},O=()=>{C(null),l(!1),[localStorage,sessionStorage].forEach(e=>{e.removeItem(S),e.removeItem(E),e.removeItem(w),e.removeItem(_)}),localStorage.removeItem(T)},F=()=>{let e=k().getItem(_);return!!e&&parseInt(e,10)-Date.now()<3e5},L=async()=>{let e=k().getItem(E),t=k().getItem(w);if(!e||!t)return!1;try{var n;let o=m().getCurrentUser();if(o)return new Promise(e=>{o.getSession((t,n)=>{if(t||!n||!n.isValid()){O(),e(!1);return}let o=n.getIdToken().getJwtToken();if(f(o)){let t=k();C(o),t.setItem(S,o);try{let e=JSON.parse(atob(o.split(".")[1])),n=1e3*e.exp;t.setItem(_,n.toString())}catch(e){console.error("Failed to parse token expiry:",e)}e(!0)}else O(),e(!1)})});let r=new i.l({ClientId:g.ClientId,AuthFlow:"REFRESH_TOKEN_AUTH",AuthParameters:{REFRESH_TOKEN:e}}),s=await h.send(r);if(null===(n=s.AuthenticationResult)||void 0===n?void 0:n.IdToken){let n=s.AuthenticationResult.IdToken;if(f(n))return y(n,s.AuthenticationResult.RefreshToken||e,t),!0}return O(),!1}catch(e){return console.error("Failed to refresh token:",e),O(),!1}};(0,r.useEffect)(()=>{(async()=>{let e=k().getItem(S);if(console.log("Restoring token"),e){if(F()){let e=await L();if(d(!1),e)return}else if(f(e)){C(e),l(!0),p(!0),d(!1);return}else{C(e),l(!0),d(!1);return}}let t=m().getCurrentUser();t?t.getSession((e,n)=>{if(e||!n){d(!1);return}if(n.isValid()){let e=n.getIdToken().getJwtToken(),o=n.getRefreshToken().getToken();f(e)?y(e,o,t.getUsername()):(t.signOut(),P("Access denied: Admin privileges required"))}d(!1)}):d(!1)})()},[]),(0,r.useEffect)(()=>{if(!n)return;let e=setInterval(async()=>{F()&&await L()},6e4);return()=>clearInterval(e)},[n]);let x=async function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];P(null),d(!0);let o=n?localStorage:sessionStorage,r=new s.By({Username:e,Password:t}),l=new s.TU({Username:e,Pool:I(o),Storage:o});return new Promise((t,o)=>{l.authenticateUser(r,{onSuccess:o=>{y(o.getIdToken().getJwtToken(),o.getRefreshToken().getToken(),e,n),d(!1),t()},onFailure:e=>{P(e.message),d(!1),o(e)}})})},J=async e=>{P(null),d(!0);try{let t=new i.l({ClientId:g.ClientId,AuthFlow:"USER_AUTH",AuthParameters:{USERNAME:e,PREFERRED_CHALLENGE:"EMAIL_OTP"}}),n=await h.send(t);if(n.Session)N(n.Session),d(!1);else throw Error("Failed to initiate authentication")}catch(e){throw P(e instanceof Error?e.message:"Failed to send code"),d(!1),e}},b=async function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(P(null),d(!0),!U){P("No active session. Please request a code first."),d(!1);return}try{var o;let r=new a.$({ClientId:g.ClientId,ChallengeName:"EMAIL_OTP",Session:U,ChallengeResponses:{USERNAME:e,EMAIL_OTP_CODE:t}}),s=await h.send(r);if(null===(o=s.AuthenticationResult)||void 0===o?void 0:o.IdToken){let t=s.AuthenticationResult.IdToken,o=s.AuthenticationResult.RefreshToken;y(t,o,e,n),N(null),d(!1)}else throw Error("Failed to complete authentication")}catch(e){throw P(e instanceof Error?e.message:"Failed to verify code"),d(!1),e}},D=async e=>{P(null),d(!0);let t=new s.TU({Username:e,Pool:m()});return new Promise((e,n)=>{t.forgotPassword({inputVerificationCode:()=>{d(!1),e()},onSuccess:()=>{d(!1)},onFailure:e=>{P(e.message),d(!1),n(e)}})})},H=async(e,t,n)=>{P(null),d(!0);let o=new s.TU({Username:e,Pool:m()});return new Promise((e,r)=>{o.confirmPassword(t,n,{onSuccess:()=>{d(!1),e()},onFailure:e=>{P(e.message),d(!1),r(e)}})})};return(0,o.jsx)(c.Provider,{value:{isAuthenticated:n,isAdmin:R,isLoading:u,token:v,login:x,requestPasswordlessCode:J,loginWithCode:b,logout:()=>{let e=m().getCurrentUser();e&&e.signOut(),O()},error:A,resetPassword:D,confirmResetPassword:H},children:t})}function C(){let e=(0,r.useContext)(c);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},8075:()=>{}}]);